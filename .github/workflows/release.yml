name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.2.3)'
        required: true
        type: string
      run_linux:
        description: 'Run Linux release job'
        required: false
        type: boolean
        default: false
      run_macos:
        description: 'Run macOS release job'
        required: false
        type: boolean
        default: false
      run_windows:
        description: 'Run Windows release job'
        required: false
        type: boolean
        default: false
      run_android:
        description: 'Run Android release job'
        required: false
        type: boolean
        default: false
      run_android_foss:
        description: 'Run Android FOSS release job'
        required: false
        type: boolean
        default: false
      run_ios_appstore:
        description: 'Run iOS App Store release job'
        required: false
        type: boolean
        default: false
      run_macos_appstore:
        description: 'Run macOS App Store release job'
        required: false
        type: boolean
        default: false
      run_update_packages:
        description: 'Run Scoop/Winget update job'
        required: false
        type: boolean
        default: false
      run_bump_official_cask:
        description: 'Run official Homebrew cask bump job'
        required: false
        type: boolean
        default: false
      run_update_linux_repos:
        description: 'Run Linux repo publish job'
        required: false
        type: boolean
        default: false
      run_publish_chocolatey:
        description: 'Run Chocolatey publish job'
        required: false
        type: boolean
        default: false
      run_update_aur:
        description: 'Run AUR binary package update job'
        required: false
        type: boolean
        default: false
      run_update_aur_source:
        description: 'Run AUR source package update job'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  linux:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.run_linux }}
    uses: ./.github/workflows/release-linux.yml
    secrets: inherit

  macos:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.run_macos }}
    uses: ./.github/workflows/release-macos.yml
    secrets: inherit

  windows:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.run_windows }}
    uses: ./.github/workflows/release-windows.yml
    secrets: inherit

  android:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.run_android }}
    uses: ./.github/workflows/release-android.yml
    secrets: inherit

  android-foss:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.run_android_foss }}
    uses: ./.github/workflows/release-android-foss.yml
    secrets: inherit

  ios-appstore:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.run_ios_appstore }}
    uses: ./.github/workflows/release-ios-appstore.yml
    with:
      upload: true
      submit_for_review: true
      testflight_group: 'external_testing'
    secrets: inherit

  macos-appstore:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.run_macos_appstore }}
    uses: ./.github/workflows/release-macos-appstore.yml
    with:
      upload: true
      submit_for_review: true
      testflight_group: 'external_testing'
    secrets: inherit

  release:
    if: ${{ github.event_name != 'workflow_dispatch' || (inputs.run_linux && inputs.run_macos && inputs.run_windows && inputs.run_android && inputs.run_android_foss) }}
    needs: [linux, macos, windows, android, android-foss]
    runs-on: ubuntu-latest
    name: Create Release
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Validate release tag
        id: release_version
        env:
          INPUT_TAG: ${{ github.event.inputs.tag }}
          GITHUB_EVENT_INPUTS_TAG: ${{ github.event.inputs.tag }}
        run: scripts/ci/resolve-release-version.sh "$INPUT_TAG" >> "$GITHUB_OUTPUT"

      - name: Download build artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          pattern: release-*
          path: ./release-assets
          merge-multiple: true

      - name: List release assets
        run: ls -la ./release-assets/ || echo "No assets found"

      - name: Validate release assets
        run: |
          set -euo pipefail
          count="$(find ./release-assets -maxdepth 1 -type f | wc -l | tr -d ' ')"
          if [ "${count}" -eq 0 ]; then
            echo "No release artifacts were downloaded. Aborting release creation."
            exit 1
          fi
          echo "Release asset count: ${count}"

      - name: Resolve release notes
        id: release_notes
        run: |
          CURRENT_TAG="${{ steps.release_version.outputs.tag }}"
          NOTES_PATH="docs/release-notes/${CURRENT_TAG}.md"
          ALT_NOTES_PATH="docs/release-notes/${CURRENT_TAG#v}.md"
          if [ -f "$NOTES_PATH" ]; then
            echo "Using release notes at $NOTES_PATH"
            echo "body_path=$NOTES_PATH" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ -f "$ALT_NOTES_PATH" ]; then
            echo "Using release notes at $ALT_NOTES_PATH"
            echo "body_path=$ALT_NOTES_PATH" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "No release notes file found; falling back to generated changelog."
          echo "body_path=CHANGELOG.md" >> "$GITHUB_OUTPUT"

      - name: Generate Changelog
        id: changelog
        if: ${{ steps.release_notes.outputs.body_path == 'CHANGELOG.md' }}
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG="${{ steps.release_version.outputs.tag }}"
          echo "## What's Changed in $CURRENT_TAG" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          if [ -n "$PREV_TAG" ]; then
            git log --pretty=format:"- %s" $PREV_TAG..HEAD >> CHANGELOG.md
          else
            git log --pretty=format:"- %s" >> CHANGELOG.md
          fi
          echo "" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREV_TAG...$CURRENT_TAG" >> CHANGELOG.md

      - name: Create Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          files: ./release-assets/*
          body_path: ${{ steps.release_notes.outputs.body_path }}
          draft: false
          prerelease: ${{ contains(steps.release_version.outputs.tag, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-packages:
    needs: release
    runs-on: ubuntu-latest
    name: Update Scoop/Winget Packages
    timeout-minutes: 45
    permissions:
      contents: read
    if: ${{ always() && ((startsWith(github.ref, 'refs/tags/') && github.event_name == 'push' && needs.release.result == 'success') || (github.event_name == 'workflow_dispatch' && inputs.run_update_packages && (needs.release.result == 'success' || needs.release.result == 'skipped'))) }}
    steps:
      - name: Checkout release repo
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          path: source

      - name: Checkout packages repo
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          repository: dongdongbh/homebrew-mindwtr
          token: ${{ secrets.PACKAGES_REPO_TOKEN }}
          path: packages-repo

      - name: Resolve release version
        id: version
        env:
          INPUT_TAG: ${{ github.event.inputs.tag }}
          GITHUB_EVENT_INPUTS_TAG: ${{ github.event.inputs.tag }}
        run: source/scripts/ci/resolve-release-version.sh "$INPUT_TAG" >> "$GITHUB_OUTPUT"

      - name: Download release assets and compute hashes
        id: hashes
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"

          URL_EXE="https://github.com/${{ github.repository }}/releases/download/${TAG}/mindwtr_${VERSION}_x64-setup.exe"

          echo "Waiting for release assets to become available..."
          for attempt in $(seq 1 10); do
            if curl -fsI "$URL_EXE" >/dev/null; then
              echo "Release assets are available."
              break
            fi
            if [ "$attempt" -eq 10 ]; then
              echo "Release assets not available after waiting."
              exit 1
            fi
            sleep 15
          done

          curl -fL -o mindwtr.exe "$URL_EXE"

          SHA_EXE=$(sha256sum mindwtr.exe | awk '{print $1}')

          echo "sha_exe=$SHA_EXE" >> "$GITHUB_OUTPUT"

      - name: Update Scoop manifest
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SHA_EXE="${{ steps.hashes.outputs.sha_exe }}"
          URL_EXE="https://github.com/${{ github.repository }}/releases/download/v${VERSION}/mindwtr_${VERSION}_x64-setup.exe#/dl.7z"

          FILE="packages-repo/bucket/mindwtr.json"
          jq --arg v "$VERSION" \
             --arg url "$URL_EXE" \
             --arg hash "$SHA_EXE" \
             '.version = $v
              | .architecture."64bit".url = $url
              | .architecture."64bit".hash = $hash
             | .autoupdate.architecture."64bit".url = "https://github.com/dongdongbh/Mindwtr/releases/download/v\($v)/mindwtr_\($v)_x64-setup.exe#/dl.7z"' \
             "$FILE" > "$FILE.tmp" && mv "$FILE.tmp" "$FILE"

      - name: Check Winget package exists
        id: winget_check
        run: |
          PKG_ID="dongdongbh.Mindwtr"
          PKG_LOWER="${PKG_ID,,}"
          FIRST="${PKG_LOWER:0:1}"
          URL="https://github.com/microsoft/winget-pkgs/tree/master/manifests/${FIRST}/${PKG_ID//./\/}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)
          if [ "$STATUS" = "200" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Winget package not found yet; skipping submission."
          fi

      - name: Checkout winget-pkgs fork
        if: steps.winget_check.outputs.exists == 'true'
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          repository: dongdongbh/winget-pkgs
          token: ${{ secrets.PACKAGES_REPO_TOKEN }}
          path: winget-pkgs

      - name: Prepare Winget manifests
        if: steps.winget_check.outputs.exists == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          REPO="${{ github.repository }}"
          SHA_EXE="${{ steps.hashes.outputs.sha_exe }}"
          RELEASE_DATE="$(date -u +%Y-%m-%d)"
          INSTALLER_URL="https://github.com/${REPO}/releases/download/${TAG}/mindwtr_${VERSION}_x64-setup.exe"
          MANIFEST_DIR="winget-pkgs/manifests/d/dongdongbh/Mindwtr/${VERSION}"

          mkdir -p "$MANIFEST_DIR"

          cat <<EOF | sed 's/^          //' > "$MANIFEST_DIR/dongdongbh.Mindwtr.installer.yaml"
          # yaml-language-server: \$schema=https://aka.ms/winget-manifest.installer.1.10.0.schema.json
          PackageIdentifier: dongdongbh.Mindwtr
          PackageVersion: ${VERSION}
          InstallerLocale: en-US
          InstallerType: nullsoft
          Scope: user
          InstallModes:
            - interactive
            - silent
            - silentWithProgress
          InstallerSwitches:
            Silent: /S /CURRENTUSER
            SilentWithProgress: /S /CURRENTUSER
          UpgradeBehavior: install
          Commands:
            - mindwtr
          ProductCode: Mindwtr
          ReleaseDate: ${RELEASE_DATE}
          AppsAndFeaturesEntries:
            - ProductCode: Mindwtr
          InstallationMetadata:
            DefaultInstallLocation: '%LOCALAPPDATA%\\Programs\\Mindwtr'
          Installers:
            - Architecture: x64
              InstallerUrl: ${INSTALLER_URL}
              InstallerSha256: ${SHA_EXE}
          ManifestType: installer
          ManifestVersion: 1.10.0
          EOF

          INSTALLER_MANIFEST="$MANIFEST_DIR/dongdongbh.Mindwtr.installer.yaml"
          test -s "$INSTALLER_MANIFEST"

          cat <<EOF | sed 's/^          //' > "$MANIFEST_DIR/dongdongbh.Mindwtr.locale.en-US.yaml"
          # yaml-language-server: \$schema=https://aka.ms/winget-manifest.defaultLocale.1.10.0.schema.json
          PackageIdentifier: dongdongbh.Mindwtr
          PackageVersion: ${VERSION}
          PackageLocale: en-US
          Publisher: dongdongbh
          PublisherUrl: https://github.com/dongdongbh
          PublisherSupportUrl: https://github.com/dongdongbh/Mindwtr/issues
          Author: dongdongbh
          PackageName: Mindwtr
          PackageUrl: https://github.com/dongdongbh/Mindwtr
          License: AGPL-3.0
          LicenseUrl: https://github.com/dongdongbh/Mindwtr/blob/HEAD/LICENSE
          ShortDescription: A complete Getting Things Done (GTD) productivity system.
          Description: A complete Getting Things Done (GTD) productivity system.
          Moniker: mindwtr
          Tags:
            - cross-platform
            - getting-things-done
            - gtd
            - gtd-applications
            - gtd-workflow
            - personal-management
            - productivity
            - second-brain
            - task-management
            - todo-app
          ReleaseNotesUrl: https://github.com/${REPO}/releases/tag/${TAG}
          ManifestType: defaultLocale
          ManifestVersion: 1.10.0
          EOF

          cat <<EOF | sed 's/^          //' > "$MANIFEST_DIR/dongdongbh.Mindwtr.locale.zh-CN.yaml"
          # yaml-language-server: \$schema=https://aka.ms/winget-manifest.locale.1.10.0.schema.json
          PackageIdentifier: dongdongbh.Mindwtr
          PackageVersion: ${VERSION}
          PackageLocale: zh-CN
          Publisher: dongdongbh
          PublisherUrl: https://github.com/dongdongbh
          PublisherSupportUrl: https://github.com/dongdongbh/Mindwtr/issues
          Author: dongdongbh
          PackageName: Mindwtr
          PackageUrl: https://github.com/dongdongbh/Mindwtr
          License: AGPL-3.0
          LicenseUrl: https://github.com/dongdongbh/Mindwtr/blob/HEAD/LICENSE
          ShortDescription: 完整的 GTD（搞定）任务管理系统。
          Description: 完整的 GTD（搞定）任务管理系统。
          Moniker: mindwtr
          Tags:
            - cross-platform
            - getting-things-done
            - gtd
            - gtd-applications
            - gtd-workflow
            - personal-management
            - productivity
            - second-brain
            - task-management
            - todo-app
          ReleaseNotesUrl: https://github.com/${REPO}/releases/tag/${TAG}
          ManifestType: locale
          ManifestVersion: 1.10.0
          EOF

          cat <<EOF | sed 's/^          //' > "$MANIFEST_DIR/dongdongbh.Mindwtr.yaml"
          # yaml-language-server: \$schema=https://aka.ms/winget-manifest.version.1.10.0.schema.json
          PackageIdentifier: dongdongbh.Mindwtr
          PackageVersion: ${VERSION}
          DefaultLocale: en-US
          ManifestType: version
          ManifestVersion: 1.10.0
          EOF

      - name: Submit Winget PR
        if: steps.winget_check.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.PACKAGES_REPO_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BRANCH="mindwtr-${VERSION}"
          cd winget-pkgs
          git checkout -b "$BRANCH"
          git add manifests/d/dongdongbh/Mindwtr/"$VERSION"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git commit -m "New version: Mindwtr ${VERSION}"
          git push -u origin "$BRANCH"
          gh pr create \
            --repo microsoft/winget-pkgs \
            --head "dongdongbh:${BRANCH}" \
            --base master \
            --title "New version: Mindwtr ${VERSION}" \
            --body "Automated manifest update for Mindwtr ${VERSION}."

      - name: Commit and push
        run: |
          cd packages-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add bucket/mindwtr.json
          if git diff --cached --quiet; then
            echo "No package changes to commit."
            exit 0
          fi
          git commit -m "update: Mindwtr ${{ steps.version.outputs.version }}"
          git push

  bump-official-cask:
    needs: release
    runs-on: macos-latest
    name: Bump Official Homebrew Cask
    timeout-minutes: 30
    permissions:
      contents: read
    if: ${{ always() && ((startsWith(github.ref, 'refs/tags/') && github.event_name == 'push' && needs.release.result == 'success' && !contains(github.ref, '-')) || (github.event_name == 'workflow_dispatch' && inputs.run_bump_official_cask && (needs.release.result == 'success' || needs.release.result == 'skipped'))) }}
    steps:
      - name: Checkout release repo
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Resolve release tag/version
        id: version
        env:
          INPUT_TAG: ${{ github.event.inputs.tag }}
          GITHUB_EVENT_INPUTS_TAG: ${{ github.event.inputs.tag }}
        run: scripts/ci/resolve-release-version.sh "$INPUT_TAG" >> "$GITHUB_OUTPUT"

      - name: Wait for macOS release assets to be live
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"
          URL_DMG_ARM="https://github.com/${{ github.repository }}/releases/download/${TAG}/mindwtr_${VERSION}_aarch64.dmg"
          URL_DMG_INTEL="https://github.com/${{ github.repository }}/releases/download/${TAG}/mindwtr_${VERSION}_x64.dmg"

          echo "Waiting for release assets:"
          echo "  - $URL_DMG_ARM"
          echo "  - $URL_DMG_INTEL"

          for attempt in $(seq 1 20); do
            if curl -fsI "$URL_DMG_ARM" >/dev/null && curl -fsI "$URL_DMG_INTEL" >/dev/null; then
              echo "macOS assets are available."
              exit 0
            fi
            echo "Attempt $attempt/20: assets not live yet; sleeping 15s..."
            sleep 15
          done

          echo "Release assets were not available in time."
          exit 1

      - name: Configure git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Submit Homebrew cask bump PR
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.HOMEBREW_PR_TOKEN }}
        run: |
          if [ -z "${HOMEBREW_GITHUB_API_TOKEN}" ]; then
            echo "Missing HOMEBREW_PR_TOKEN secret."
            exit 1
          fi

          VERSION="${{ steps.version.outputs.version }}"
          run_bump_cask_pr() {
            HOMEBREW_NO_INSTALL_FROM_API=1 brew bump-cask-pr homebrew/cask/mindwtr --version "$VERSION" --verbose --no-browse 2>&1
          }

          set +e
          OUTPUT="$(run_bump_cask_pr)"
          STATUS=$?
          set -e
          echo "$OUTPUT"

          if [ "$STATUS" -ne 0 ] && echo "$OUTPUT" | grep -Fqi "Tap homebrew/cask already tapped"; then
            echo "Homebrew cask tap conflict detected; retrying once after untap."
            brew untap homebrew/cask >/dev/null 2>&1 || true
            set +e
            OUTPUT="$(run_bump_cask_pr)"
            STATUS=$?
            set -e
            echo "$OUTPUT"
          fi

          if [ "$STATUS" -ne 0 ]; then
            if echo "$OUTPUT" | grep -Eiq "already (at version|up[ -]?to[ -]?date)|no changes"; then
              echo "Official cask is already at version $VERSION; skipping."
              exit 0
            fi
            if echo "$OUTPUT" | grep -Eiq "BrewTestBot|autobump|no_autobump"; then
              echo "Official cask is BrewTestBot-managed; skipping manual bump."
              exit 0
            fi
            exit "$STATUS"
          fi

  update-linux-repos:
    needs: release
    if: ${{ always() && ((startsWith(github.ref, 'refs/tags/') && github.event_name == 'push' && needs.release.result == 'success') || (github.event_name == 'workflow_dispatch' && inputs.run_update_linux_repos && (needs.release.result == 'success' || needs.release.result == 'skipped'))) }}
    permissions:
      contents: write
    uses: ./.github/workflows/publish-repo.yml
    secrets: inherit
    with:
      tag: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}

  publish-chocolatey:
    needs: release
    runs-on: windows-latest
    name: Publish Chocolatey
    timeout-minutes: 45
    permissions:
      contents: read
    if: ${{ always() && ((startsWith(github.ref, 'refs/tags/') && github.event_name == 'push' && needs.release.result == 'success' && !contains(github.ref, '-')) || (github.event_name == 'workflow_dispatch' && inputs.run_publish_chocolatey && (needs.release.result == 'success' || needs.release.result == 'skipped'))) && vars.CHOCOLATEY_PUBLISH_ENABLED == 'true' }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Resolve release tag/version
        id: version
        shell: pwsh
        run: |
          $inputTag = "${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}"
          $env:GITHUB_EVENT_INPUTS_TAG = "${{ github.event.inputs.tag }}"
          $lines = & scripts/ci/resolve-release-version.ps1 -InputTag $inputTag
          foreach ($line in $lines) {
            $line >> $env:GITHUB_OUTPUT
          }

      - name: Download Windows installer and compute SHA256
        id: installer
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'
          $tag = "${{ steps.version.outputs.tag }}"
          $version = "${{ steps.version.outputs.version }}"
          $url = "https://github.com/${{ github.repository }}/releases/download/$tag/mindwtr_${version}_x64-setup.exe"
          Write-Host "Waiting for release asset: $url"
          $maxAttempts = 20
          for ($attempt = 1; $attempt -le $maxAttempts; $attempt++) {
            try {
              $response = Invoke-WebRequest -Uri $url -Method Head -MaximumRedirection 10 -ErrorAction Stop
              if ($response.StatusCode -ge 200 -and $response.StatusCode -lt 400) {
                break
              }
            } catch {
              if ($attempt -eq $maxAttempts) {
                throw "Release asset unavailable after $maxAttempts attempts: $url"
              }
              Start-Sleep -Seconds 15
            }
          }
          $outFile = Join-Path $PWD "mindwtr-${version}-setup.exe"
          Invoke-WebRequest -Uri $url -OutFile $outFile -MaximumRedirection 10
          $sha = (Get-FileHash -Path $outFile -Algorithm SHA256).Hash.ToLowerInvariant()
          "installer_url=$url" >> $env:GITHUB_OUTPUT
          "installer_path=$outFile" >> $env:GITHUB_OUTPUT
          "sha256=$sha" >> $env:GITHUB_OUTPUT
          Write-Host "Installer SHA256: $sha"

      - name: Ensure Chocolatey CLI exists
        shell: pwsh
        run: |
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
            throw "Chocolatey CLI (choco) not found on runner."
          }
          choco --version

      - name: Build Chocolatey package (auto-generated install script)
        id: pack
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'
          $version = "${{ steps.version.outputs.version }}"
          $installerUrl = "${{ steps.installer.outputs.installer_url }}"
          $sha = "${{ steps.installer.outputs.sha256 }}"

          $pkgRoot = Join-Path $PWD "chocolatey-package"
          $toolsDir = Join-Path $pkgRoot "tools"
          New-Item -ItemType Directory -Force -Path $toolsDir | Out-Null

          Copy-Item "metadata/chocolatey/mindwtr.nuspec" -Destination (Join-Path $pkgRoot "mindwtr.nuspec") -Force
          $template = Get-Content -Raw "metadata/chocolatey/tools/chocolateyInstall.ps1.template"
          $installScript = $template.Replace("__INSTALLER_URL__", $installerUrl).Replace("__CHECKSUM__", $sha)
          Set-Content -Path (Join-Path $toolsDir "chocolateyInstall.ps1") -Value $installScript -Encoding UTF8 -NoNewline

          Push-Location $pkgRoot
          choco pack "mindwtr.nuspec" --version "$version"
          Pop-Location

          $nupkg = Get-ChildItem -Path $pkgRoot -Filter "mindwtr.$version.nupkg" | Select-Object -First 1
          if (-not $nupkg) {
            throw "Failed to generate Chocolatey package for version $version."
          }
          "nupkg_path=$($nupkg.FullName)" >> $env:GITHUB_OUTPUT
          Write-Host "Generated package: $($nupkg.FullName)"

      - name: Smoke test Chocolatey package locally
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'
          $pkgRoot = Join-Path $PWD "chocolatey-package"
          choco install mindwtr --source "$pkgRoot" --force --no-progress -y

      - name: Push package to Chocolatey
        shell: pwsh
        env:
          CHOCOLATEY_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'
          if ([string]::IsNullOrWhiteSpace($env:CHOCOLATEY_API_KEY)) {
            throw "Missing CHOCOLATEY_API_KEY secret."
          }
          $nupkg = "${{ steps.pack.outputs.nupkg_path }}"
          $output = choco push "$nupkg" --source "https://push.chocolatey.org/" --api-key "$env:CHOCOLATEY_API_KEY" --timeout 2700 2>&1
          $exitCode = $LASTEXITCODE
          $text = ($output | Out-String)
          Write-Host $text
          if ($exitCode -ne 0) {
            if ($text -match "already exists") {
              Write-Host "Chocolatey package version already exists. Skipping duplicate push."
              exit 0
            }
            throw "Chocolatey push failed."
          }

  update-aur:
    needs: release
    runs-on: ubuntu-latest
    name: Update AUR
    timeout-minutes: 30
    permissions:
      contents: read
    if: ${{ always() && ((startsWith(github.ref, 'refs/tags/') && github.event_name == 'push' && needs.release.result == 'success') || (github.event_name == 'workflow_dispatch' && inputs.run_update_aur && (needs.release.result == 'success' || needs.release.result == 'skipped'))) }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Resolve release version
        id: version
        env:
          INPUT_TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
          GITHUB_EVENT_INPUTS_TAG: ${{ github.event.inputs.tag }}
        run: scripts/ci/resolve-release-version.sh "$INPUT_TAG" >> "$GITHUB_OUTPUT"

      - name: Update PKGBUILD version
        run: |
          VERSION=${{ steps.version.outputs.version }}
          echo "Updating PKGBUILD to version $VERSION"
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" aur/PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" aur/PKGBUILD
        shell: bash

      - name: Update .SRCINFO
        run: |
          docker run --rm \
            -v "$PWD/aur:/aur" \
            -w /aur \
            archlinux:latest \
            bash -lc "pacman -Sy --noconfirm --needed base-devel git && useradd -m builder && chown -R builder:builder /aur && su builder -c 'makepkg --printsrcinfo > .SRCINFO'"
        shell: bash

      - name: Publish to AUR
        uses: KSXGitHub/github-actions-deploy-aur@a97f56a8425a7a7f3b8c58607f769c69b089cadb # v3
        with:
          pkgname: mindwtr-bin
          pkgbuild: ./aur/PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: Update to ${{ github.ref_name }}
          updpkgsums: true

  update-aur-source:
    needs: release
    runs-on: ubuntu-latest
    name: Update AUR (mindwtr)
    timeout-minutes: 30
    permissions:
      contents: read
    if: ${{ always() && ((startsWith(github.ref, 'refs/tags/') && github.event_name == 'push' && needs.release.result == 'success') || (github.event_name == 'workflow_dispatch' && inputs.run_update_aur_source && (needs.release.result == 'success' || needs.release.result == 'skipped'))) }}
    steps:
      - name: Checkout release repo
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          path: source

      - name: Configure SSH for AUR
        shell: bash
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
        run: |
          if [ -z "${AUR_SSH_PRIVATE_KEY}" ]; then
            echo "Missing AUR_SSH_PRIVATE_KEY secret."
            exit 1
          fi
          install -d -m 700 ~/.ssh
          printf '%s\n' "${AUR_SSH_PRIVATE_KEY}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          cat > ~/.ssh/config <<'EOF'
          Host aur.archlinux.org
            HostName aur.archlinux.org
            User aur
            IdentityFile ~/.ssh/aur
            IdentitiesOnly yes
            StrictHostKeyChecking yes
          EOF
          ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts

      - name: Clone AUR repo
        shell: bash
        run: git clone ssh://aur@aur.archlinux.org/mindwtr.git aur-mindwtr

      - name: Resolve release version
        id: version
        env:
          INPUT_TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
          GITHUB_EVENT_INPUTS_TAG: ${{ github.event.inputs.tag }}
        run: source/scripts/ci/resolve-release-version.sh "$INPUT_TAG" >> "$GITHUB_OUTPUT"

      - name: Update PKGBUILD version
        id: pkgbuild_version
        shell: bash
        working-directory: aur-mindwtr
        run: |
          VERSION=${{ steps.version.outputs.version }}
          echo "Updating mindwtr PKGBUILD to version $VERSION"
          CURRENT_PKGVER="$(sed -n 's/^pkgver=//p' PKGBUILD | head -n 1)"
          if [ "$CURRENT_PKGVER" != "$VERSION" ]; then
            sed -i "s/^pkgver=.*/pkgver=$VERSION/" PKGBUILD
            sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
            echo "pkgver_changed=true" >> "$GITHUB_OUTPUT"
            echo "pkgver changed (${CURRENT_PKGVER} -> ${VERSION}); reset pkgrel to 1"
          else
            echo "pkgver_changed=false" >> "$GITHUB_OUTPUT"
            echo "pkgver unchanged (${VERSION}); keep current pkgrel for now"
          fi

      - name: Update checksums
        shell: bash
        working-directory: aur-mindwtr
        run: |
          HOST_UID="$(id -u)"
          HOST_GID="$(id -g)"
          docker run --rm \
            -e HOST_UID="$HOST_UID" \
            -e HOST_GID="$HOST_GID" \
            -v "$PWD:/aur" \
            -w /aur \
            archlinux:latest \
            bash -lc '
              set -euo pipefail
              pacman -Sy --noconfirm --needed base-devel git pacman-contrib
              getent group "$HOST_GID" >/dev/null 2>&1 || groupadd -g "$HOST_GID" builder
              id -u builder >/dev/null 2>&1 || useradd -m -u "$HOST_UID" -g "$HOST_GID" builder
              if command -v updpkgsums >/dev/null 2>&1; then
                su builder -c "updpkgsums"
              else
                # Fallback path if updpkgsums is unavailable.
                su builder -c "makepkg -g > /tmp/makepkg-sums.txt"
                awk "
                  /^[_[:alnum:]]*sums=\\(/ { in_sums=1; next }
                  in_sums && /^\\)/ { in_sums=0; next }
                  !in_sums { print }
                " /aur/PKGBUILD > /tmp/PKGBUILD.nosums
                {
                  cat /tmp/PKGBUILD.nosums
                  cat /tmp/makepkg-sums.txt
                } > /aur/PKGBUILD
              fi
            '

      - name: Bump pkgrel for checksum-only changes
        shell: bash
        working-directory: aur-mindwtr
        run: |
          if [ "${{ steps.pkgbuild_version.outputs.pkgver_changed }}" = "false" ] && ! git diff --quiet -- PKGBUILD; then
            CURRENT_PKGREL="$(sed -n 's/^pkgrel=//p' PKGBUILD | head -n 1)"
            if [[ "$CURRENT_PKGREL" =~ ^[0-9]+$ ]]; then
              NEW_PKGREL="$((CURRENT_PKGREL + 1))"
              sed -i "s/^pkgrel=.*/pkgrel=${NEW_PKGREL}/" PKGBUILD
              echo "pkgver unchanged and checksums changed; bump pkgrel ${CURRENT_PKGREL} -> ${NEW_PKGREL}"
            else
              echo "::error::pkgrel is not numeric (${CURRENT_PKGREL}); cannot auto-bump."
              exit 1
            fi
          fi

      - name: Update .SRCINFO
        shell: bash
        working-directory: aur-mindwtr
        run: |
          HOST_UID="$(id -u)"
          HOST_GID="$(id -g)"
          docker run --rm \
            -e HOST_UID="$HOST_UID" \
            -e HOST_GID="$HOST_GID" \
            -v "$PWD:/aur" \
            -w /aur \
            archlinux:latest \
            bash -lc '
              set -euo pipefail
              pacman -Sy --noconfirm --needed base-devel git
              getent group "$HOST_GID" >/dev/null 2>&1 || groupadd -g "$HOST_GID" builder
              id -u builder >/dev/null 2>&1 || useradd -m -u "$HOST_UID" -g "$HOST_GID" builder
              su builder -c "makepkg --printsrcinfo > /aur/.SRCINFO"
            '

      - name: Commit and push changes
        shell: bash
        working-directory: aur-mindwtr
        env:
          AUR_USERNAME: ${{ secrets.AUR_USERNAME }}
          AUR_EMAIL: ${{ secrets.AUR_EMAIL }}
        run: |
          if git diff --quiet -- PKGBUILD .SRCINFO; then
            echo "No AUR source-package changes to publish."
            exit 0
          fi
          git config user.name "${AUR_USERNAME:-mindwtr-bot}"
          git config user.email "${AUR_EMAIL:-actions@github.com}"
          git add PKGBUILD .SRCINFO
          git commit -m "Update to ${{ steps.version.outputs.tag }}"
          git push origin HEAD
