name: Release Android

on:
  workflow_call:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.2.3)'
        required: false
        type: string
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.2.3)'
        required: false
        type: string

permissions:
  contents: read

concurrency:
  group: release-android
  cancel-in-progress: true

jobs:
  android:
    runs-on: ubuntu-latest
    name: Android Build + Publish
    timeout-minutes: 90

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 20

      - name: Setup Java
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9 # v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407 # v3

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: "1.x"

      - name: Install dependencies
        run: bun install

      - name: Authenticate Google Play API
        id: play_auth
        uses: google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed # v2
        with:
          credentials_json: ${{ secrets.ANDROID_SERVICE_ACCOUNT_JSON }}
          token_format: access_token
          access_token_scopes: https://www.googleapis.com/auth/androidpublisher

      - name: Ensure Android versionCode is unique
        env:
          ACCESS_TOKEN: ${{ steps.play_auth.outputs.access_token }}
        run: |
          PACKAGE="tech.dongdongbh.mindwtr"
          EDIT_ID=$(curl -s -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE/edits" \
            -d '{}' | jq -r '.id')
          if [ -z "$EDIT_ID" ] || [ "$EDIT_ID" = "null" ]; then
            echo "Failed to create Google Play edit" >&2
            exit 1
          fi
          TRACKS_FILE=$(mktemp)
          TRACKS_CODE=$(curl -sS -o "$TRACKS_FILE" -w "%{http_code}" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE/edits/$EDIT_ID/tracks")
          TRACKS_JSON=$(cat "$TRACKS_FILE")
          if [ "$TRACKS_CODE" != "200" ]; then
            echo "Failed to fetch Google Play tracks (HTTP $TRACKS_CODE): $TRACKS_JSON" >&2
            exit 1
          fi
          if echo "$TRACKS_JSON" | jq -e '.error' >/dev/null; then
            echo "Failed to fetch Google Play tracks: $TRACKS_JSON" >&2
            exit 1
          fi
          MAX_CODE=$(echo "$TRACKS_JSON" | jq -r '[(.tracks // [])[]? | (.releases // [])[]? | (.versionCodes // [])[]? | tonumber] | max // 0')
          if [ -z "$MAX_CODE" ] || [ "$MAX_CODE" = "null" ]; then
            MAX_CODE=0
          fi
          curl -s -X DELETE \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE/edits/$EDIT_ID" >/dev/null
          LOCAL_CODE=$(jq -r '.expo.android.versionCode' apps/mobile/app.json)
          if [ -z "$LOCAL_CODE" ] || [ "$LOCAL_CODE" = "null" ]; then
            echo "Missing expo.android.versionCode in apps/mobile/app.json" >&2
            exit 1
          fi
          if [ "$MAX_CODE" -ge "$LOCAL_CODE" ]; then
            NEW_CODE=$((MAX_CODE + 1))
            jq ".expo.android.versionCode = $NEW_CODE" apps/mobile/app.json > apps/mobile/app.json.tmp
            mv apps/mobile/app.json.tmp apps/mobile/app.json
            echo "Bumped versionCode to $NEW_CODE (store max was $MAX_CODE)"
          else
            echo "versionCode ok: local $LOCAL_CODE > store $MAX_CODE"
          fi

      - name: Setup EAS CLI
        run: npm install -g eas-cli

      - name: Resolve version
        id: version
        run: |
          INPUT_TAG="${{ inputs.tag || github.event.inputs.tag }}"
          GITHUB_EVENT_INPUTS_TAG="${{ github.event.inputs.tag }}"
          scripts/ci/resolve-release-version.sh "$INPUT_TAG" >> "$GITHUB_OUTPUT"

      - name: Build Android AAB (local EAS)
        timeout-minutes: 60
        run: |
          VERSION=${{ steps.version.outputs.version }}
          cd apps/mobile
          MINDWTR_ANDROID_ARCHS=arm64-v8a,armeabi-v7a eas build --platform android --profile production --local --non-interactive --output ./build/mindwtr-${VERSION}.aab
          ls -la ./build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          ANALYTICS_HEARTBEAT_URL: ${{ secrets.ANALYTICS_HEARTBEAT_URL }}

      - name: Prepare Google Play release notes
        run: |
          VERSION=${{ steps.version.outputs.version }}
          NOTES_FILE="docs/release-notes/google-play/${VERSION}.txt"
          if [ ! -f "$NOTES_FILE" ]; then
            echo "Missing release notes file: $NOTES_FILE" >&2
            exit 1
          fi
          OUT_DIR="apps/mobile/build/play-release-notes"
          rm -rf "$OUT_DIR"
          mkdir -p "$OUT_DIR"
          awk -v out="$OUT_DIR" '
            /^<[^>]+>$/ {
              tag=$0
              gsub(/[<>]/, "", tag)
              file=out "/whatsnew-" tag
              next
            }
            /^<\/[^>]+>$/ {
              tag=""
              next
            }
            tag != "" { print >> file }
          ' "$NOTES_FILE"
          ls -la "$OUT_DIR"

      - name: Publish to Google Play Store
        if: startsWith(github.ref, 'refs/tags/') && github.event_name != 'workflow_dispatch'
        uses: r0adkll/upload-google-play@935ef9c68bb393a8e6116b1575626a7f5be3a7fb # v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.ANDROID_SERVICE_ACCOUNT_JSON }}
          packageName: tech.dongdongbh.mindwtr
          releaseFiles: apps/mobile/build/mindwtr-*.aab
          track: production
          status: completed
          releaseName: ${{ steps.version.outputs.version }}
          whatsNewDirectory: apps/mobile/build/play-release-notes
