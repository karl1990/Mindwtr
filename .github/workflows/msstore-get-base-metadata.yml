name: Microsoft Store - Get Base Metadata

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  MS_TENANT_ID: ${{ secrets.MS_TENANT_ID || secrets.AZURE_AD_TENANT_ID }}
  MS_SELLER_ID: ${{ secrets.MS_SELLER_ID || secrets.SELLER_ID }}
  MS_CLIENT_ID: ${{ secrets.MS_CLIENT_ID || secrets.AZURE_AD_APPLICATION_CLIENT_ID }}
  MS_CLIENT_SECRET: ${{ secrets.MS_CLIENT_SECRET || secrets.AZURE_AD_APPLICATION_SECRET }}
  MS_STORE_APP_ID: ${{ secrets.MS_STORE_APP_ID }}

jobs:
  get-metadata:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Microsoft Store CLI
        uses: microsoft/microsoft-store-apppublisher@v1.1

      - name: Validate Microsoft Store secrets
        shell: pwsh
        run: |
          $required = @('MS_TENANT_ID','MS_SELLER_ID','MS_CLIENT_ID','MS_CLIENT_SECRET','MS_STORE_APP_ID')
          foreach ($name in $required) {
            if (-not (Get-Item -Path "env:$name" -ErrorAction SilentlyContinue)) {
              Write-Error "$name is missing. Please set it in repository secrets."
            }
          }

      - name: Reconfigure store credentials
        shell: pwsh
        run: |
          msstore reconfigure `
            --tenantId $env:MS_TENANT_ID `
            --sellerId $env:MS_SELLER_ID `
            --clientId $env:MS_CLIENT_ID `
            --clientSecret $env:MS_CLIENT_SECRET

      - name: Get base metadata
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path metadata | Out-Null
          msstore submission get $env:MS_STORE_APP_ID | Out-File -FilePath metadata/metadata.json -Encoding UTF8

      - name: Upload metadata artifact
        uses: actions/upload-artifact@v4
        with:
          name: msstore-metadata
          path: metadata/metadata.json
